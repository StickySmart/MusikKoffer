<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Tiage Music Masterplan 25</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    header { background: #111; color: #fff; padding: 0.5rem 1rem;
             display: flex; justify-content: space-between; align-items: center; }
    #menuBtn, #topButtons button {
      background: #444; color: #fff; border: none; padding: 0.3rem 0.6rem; cursor: pointer;
    }
    #sidebar { width: 260px; background: #f5f5f5; border-right: 1px solid #ddd;
               overflow-y: auto; transition: transform 0.3s ease; }
    #sidebar.hidden { transform: translateX(-100%); }
    main { display: flex; height: calc(100vh - 50px); }
    #content { flex: 1; padding: 1rem; overflow-y: auto; }
    table { border-collapse: collapse; margin-top: 1rem; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background: #eee; }
  </style>
</head>
<body>
  <header>
    <h1>Tiage Music Masterplan 25</h1>
    <div id="topButtons">
      <button id="exportJ1">ExpJ1</button>
      <button id="importJ2">ImpJ2</button>
      <button id="menuBtn">☰</button>
    </div>
  </header>

  <main>
    <nav id="sidebar">Lade Manifest …</nav>
    <section id="content"><h2>Willkommen</h2><p>Bitte Kapitel oder Modul wählen…</p></section>
  </main>

  <script>
    const sidebar = document.getElementById("sidebar");
    const content = document.getElementById("content");
    const menuBtn = document.getElementById("menuBtn");

    menuBtn.addEventListener("click", () => {
      sidebar.classList.toggle("hidden");
    });

    async function loadManifest() {
      try {
        const res = await fetch("manifest.json?v=" + Date.now());
        const manifest = await res.json();

        let html = "<h3>Kapitel</h3>";
        html += manifest.chapters.map(ch =>
          `<p><a href="#" data-type="chapter" data-path="${ch.path}">${ch.id} – ${ch.title}</a></p>`
        ).join("");

        html += "<h3>Module</h3>";
        html += manifest.modules.map(mod =>
          `<p><a href="#" data-type="module" data-path="${mod.source}">${mod.id} – ${mod.purpose}</a></p>`
        ).join("");

        sidebar.innerHTML = html;

        sidebar.querySelectorAll("a").forEach(link => {
          link.addEventListener("click", async e => {
            e.preventDefault();
            const type = e.target.dataset.type;
            const path = e.target.dataset.path;
            if (type === "chapter") {
              await loadChapter(path);
            } else if (type === "module") {
              await loadModule(path);
            }
            sidebar.classList.add("hidden");
          });
        });
      } catch (err) {
        content.innerHTML = `<p style="color:red">Fehler beim Laden des Manifests: ${err}</p>`;
      }
    }

    async function loadChapter(path) {
      try {
        const res = await fetch(path);
        if (!res.ok) throw new Error(`${path} → ${res.status}`);
        const text = await res.text();
        content.innerHTML = `<article><pre>${text}</pre></article>`;
      } catch (err) {
        content.innerHTML = `<p style="color:red">Fehler beim Laden des Kapitels: ${err}</p>`;
      }
    }

    async function loadModule(path) {
      try {
        const res = await fetch(path);
        if (!res.ok) throw new Error(`${path} → ${res.status}`);
        const text = await res.text();

        if (path.endsWith(".xml")) {
          renderXML(text, path);
        } else {
          const escaped = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
          content.innerHTML = `<article><pre>${escaped}</pre></article>`;
        }
      } catch (err) {
        content.innerHTML = `<p style="color:red">Fehler beim Laden des Moduls: ${err}</p>`;
      }
    }

    function renderXML(xmlText, path) {
      try {
        const parser = new DOMParser();
        const xml = parser.parseFromString(xmlText, "application/xml");

        // Geräteübersicht aus geraetesetup.xml
        if (path.includes("geraetesetup")) {
          const devices = xml.getElementsByTagName("device");
          let html = "<h2>Geräte-Setup</h2><table><tr><th>ID</th><th>Name</th><th>Hersteller</th><th>Typ</th></tr>";
          [...devices].forEach(dev => {
            const id = dev.getAttribute("id");
            const name = dev.getAttribute("name") || "";
            const manufacturer = dev.getAttribute("manufacturer") || "";
            const type = dev.getAttribute("type") || "";
            html += `<tr><td>${id}</td><td>${name}</td><td>${manufacturer}</td><td>${type}</td></tr>`;
          });
          html += "</table>";
          content.innerHTML = html;
        } else {
          // Fallback: XML roh anzeigen
          const escaped = xmlText.replace(/</g, "&lt;").replace(/>/g, "&gt;");
          content.innerHTML = `<article><pre>${escaped}</pre></article>`;
        }
      } catch (err) {
        content.innerHTML = `<p style="color:red">Fehler beim Verarbeiten von XML: ${err}</p>`;
      }
    }

    loadManifest();
  </script>
</body>
</html>
