<script>
  const sidebar = document.getElementById("sidebar");
  const menuBtn = document.getElementById("menuBtn");
  const content = document.getElementById("content");
  const commentInput = document.getElementById("commentInput");
  const saveCommentBtn = document.getElementById("saveCommentBtn");

  // --- Kommentar-Speicher ---
  const allComments = {}; // alle Kommentare nach Kapitel
  let currentChapter = null;

  menuBtn.addEventListener("click", () => {
    sidebar.classList.toggle("hidden");
  });

  async function loadManifest() {
    try {
      const res = await fetch("manifest.json?v=" + Date.now());
      const manifest = await res.json();

      sidebar.innerHTML = manifest.chapters.map(ch =>
        `<p><a href="#" data-path="${ch.path}">${ch.id} – ${ch.title}</a></p>`
      ).join("");

      sidebar.querySelectorAll("a").forEach(link => {
        link.addEventListener("click", async e => {
          e.preventDefault();
          const path = e.target.dataset.path;
          await loadChapter(path);
          sidebar.classList.add("hidden");
        });
      });
    } catch (err) {
      content.innerHTML = `<p style="color:red">Fehler beim Laden des Manifests: ${err}</p>`;
    }
  }

  // --- Kapitel laden ---
  async function loadChapter(path) {
    try {
      const res = await fetch(path);
      if (!res.ok) throw new Error(`${path} → ${res.status}`);
      const text = await res.text();
      content.innerHTML = `<article><pre>${text}</pre></article>`;

      // Kommentarbereich sichtbar machen
      document.getElementById("commentSection").style.display = "block";

      // Aktuelles Kapitel merken
      currentChapter = path;

      // Vorhandenen Kommentar anzeigen, falls schon gespeichert
      commentInput.value = allComments[path]?.comment || "";
    } catch (err) {
      content.innerHTML = `<p style="color:red">Fehler beim Laden des Kapitels: ${err}</p>`;
    }
  }

  // --- Kommentar speichern ---
  saveCommentBtn.addEventListener("click", () => {
    if (!currentChapter) {
      alert("Kein Kapitel ausgewählt.");
      return;
    }

    allComments[currentChapter] = {
      chapter: currentChapter,
      comment: commentInput.value,
      status: "Offen",
      timestamp: new Date().toISOString()
    };

    console.log("Gespeichert:", allComments);
    alert("Kommentar gespeichert für " + currentChapter);
  });

  // --- Export JSON1 ---
  document.getElementById("exportJ1").addEventListener("click", () => {
    const commentsArray = Object.values(allComments);

    if (commentsArray.length === 0) {
      alert("Noch keine Kommentare vorhanden.");
      return;
    }

    const blob = new Blob([JSON.stringify(commentsArray, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'comments.json';
    a.click();
  });

  // --- Import JSON2 (Simulation) ---
  document.getElementById("importJ2").addEventListener("click", () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const json2 = JSON.parse(e.target.result);

          // Simulation: Ausgabe im Browser
          console.log("JSON2 importiert:", json2);
          alert(
            `JSON2 importiert!\nKapitel: ${json2.chapter}\nStatus: ${json2.status}\nTimestamp: ${json2.timestamp}`
          );

          // später: MD-Dateien anhand json2.updated_content anpassen
        } catch (error) {
          alert('Fehler beim Importieren der Datei: ' + error);
        }
      };
      reader.readAsText(file);
    });
    input.click();
  });

  loadManifest();
</script>
