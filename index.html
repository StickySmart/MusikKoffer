<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TiageMusic â€“ INDEX (Manifest v1.3)</title>
  <style>
    :root{--bg:#0b0c0f;--ink:#eef3fb;--ink-dim:#b8c2d4;--line:#1f2635;--card:#12141a;--pad:16px;--radius:14px;--shadow:0 8px 24px rgba(0,0,0,.35);--w-nav:280px;--accent:#7ad2ff}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.55 system-ui,Segoe UI,Roboto,Arial,sans-serif}
    a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}
    header.top{position:sticky;top:0;z-index:10;display:flex;gap:12px;align-items:center;padding:10px var(--pad);border-bottom:1px solid var(--line);background:linear-gradient(180deg,rgba(11,12,15,.92),rgba(11,12,15,.75) 60%,rgba(11,12,15,0));backdrop-filter:blur(6px)}
    .brand{font-weight:700}
    .chip{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--line);color:var(--ink-dim)}
    .wrap{display:flex;min-height:calc(100vh - 52px)}
    nav.side{width:var(--w-nav);flex:0 0 var(--w-nav);border-right:1px solid var(--line);padding:18px var(--pad);position:sticky;top:52px;height:calc(100vh - 52px);overflow:auto;background:linear-gradient(180deg,#0e1015,#0b0c0f)}
    nav h4{margin:8px 0 8px;font-size:12px;letter-spacing:.12em;color:var(--ink-dim);text-transform:uppercase}
    nav ul{list-style:none;margin:0;padding:0;display:grid;gap:6px}
    nav li a{display:block;padding:8px 10px;border-radius:10px;color:var(--ink);border:1px solid transparent}
    nav li a:hover{background:#12141a;border-color:var(--line)}
    main{flex:1;padding:20px;max-width:1200px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);margin:16px 0;overflow:hidden;position:relative}
    .card .hd{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:14px var(--pad);border-bottom:1px solid var(--line)}
    .card .hd h2{margin:0;font-size:18px}
    .card .bd{padding:16px}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#10141d;border:1px solid var(--line);color:var(--ink-dim);font-size:12px}
    .toolbar{display:flex;gap:.5rem;flex-wrap:wrap;padding:.5rem;border:1px solid var(--line);border-radius:10px;background:#0f141c;color:#dbe4ee}
    .toolbar button{appearance:none;border:1px solid var(--line);background:#141a24;color:#eaf2fb;padding:.5rem .8rem;border-radius:9px;cursor:pointer}
    .toolbar button:hover{border-color:#3a4661}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .kv{display:grid;gap:6px}
    .muted{color:var(--ink-dim)}
    [data-cid]::before{content:attr(data-cid);position:absolute;top:10px;right:10px;font-size:11px;color:var(--ink-dim);background:#0f141c;border:1px solid var(--line);padding:2px 6px;border-radius:999px}
    section{scroll-margin-top:72px}
    pre{background:#0b0f17;color:#e6edf6;border:1px solid #1f2635;padding:10px;border-radius:8px;overflow:auto}
    h3{margin:1rem 0 .4rem;font-size:1rem;color:#cbd5e1}
    .log{border:1px solid #3b82f6;color:#cfe0ff;background:#0b1325;padding:.6rem .8rem;border-radius:8px;font-family:ui-monospace,Consolas,monospace;white-space:pre-wrap}
    .log.error{border-color:#ef4444;color:#ffe2e2;background:#220b0b}
  </style>
</head>
<body>
  <header class="top">
    <div class="brand">ðŸŽ’ TiageMusic Â· INDEX</div>
    <span class="chip">Manifest v1.3</span>
    <div style="margin-left:auto" class="toolbar">
      <button id="pickFilesBtn">Dateien wÃ¤hlen (.md/.html)</button>
      <input id="filesInput" type="file" multiple accept=".md,.html,.txt" style="display:none">
      <button id="pickJson2Btn">JSON2 laden</button>
      <input id="json2Input" type="file" accept=".json,application/json" style="display:none">
      <button id="applyBtn">Anwenden</button>
    </div>
  </header>

  <div class="wrap">
    <nav class="side">
      <div>
        <h4>Ãœbersicht</h4>
        <ul>
          <li><a href="#cover">Cover</a></li>
          <li><a href="#ch02">First Steps â€“ MIDI & Setup</a></li>
          <li><a href="#ch03">First Steps â€“ Audio & Routing</a></li>
          <li><a href="#ch04">GerÃ¤teÃ¼bersicht & Texture Lab</a></li>
          <li><a href="#ch05">Workflows Audio â€“ Recording</a></li>
          <li><a href="#ch06">Workflows Audio â€“ Performance</a></li>
          <li><a href="#ch07">Workflows Audio â€“ Mixdown</a></li>
          <li><a href="#ch08">Zusammenfassung</a></li>
        </ul>
      </div>
    </nav>

    <main>
      <!-- 01 Cover -->
      <section id="cover" class="card" data-cid="01:cover">
        <div class="hd"><h2>Cover</h2><span class="pill">Kapitel 01</span></div>
        <div class="bd">
          <div class="grid">
            <div class="kv"><strong>Projekt</strong><span>TiageMusic GerÃ¤tesetup</span></div>
            <div class="kv"><strong>Version</strong><span id="ver">v1.3-index</span></div>
          </div>
          <p class="muted">Diese Seite bÃ¼ndelt Struktur & Inhalte gemÃ¤ÃŸ <code>manifest.json</code>.</p>
        </div>
      </section>

      <!-- 02 First Steps â€“ MIDI & Setup -->
      <section id="ch02" class="card" data-cid="02">
        <div class="hd"><h2>First Steps â€“ MIDI & Setup</h2><span class="pill">Kapitel 02</span></div>
        <div class="bd">
          <!-- cid:02:intro -->
          <p class="muted">Grundlagen zu KanÃ¤len, Clock, Ports, Merger und U6-Presets.</p>
          <!-- cid:02:routing-performance -->
          <h3 id="routing-performance">{#routing-performance}Routing Performance</h3>
          <ul>
            <li><b>Clock Master:</b> T-8</li>
            <li><b>Merger #5:</b> sammelt S-1, T-8, J-6, EZ-AG, Handy (USBâ†’DIN)</li>
            <li><b>KanÃ¤le:</b> S-1 = CH1 Â· EZ-AG = CH2 Â· J-6 = CH6 Â· T-8 = CH8</li>
            <li><b>Dual U6:</b> U6-1 verteilt; U6-2 versorgt E-4, TL (Clock only), L-6 (optional)</li>
          </ul>
          <p class="muted">AnhÃ¤nge: <code>portmap_json2_snippet_dualU6.json</code>, <code>u6_routing_profiles_dual.json</code></p>
        </div>
      </section>

      <!-- 03 First Steps â€“ Audio & Routing -->
      <section id="ch03" class="card" data-cid="03">
        <div class="hd"><h2>First Steps â€“ Audio & Routing</h2><span class="pill">Kapitel 03</span></div>
        <div class="bd">
          <!-- cid:03:intro -->
          <p class="muted">Signalfluss, Pegel, Monitoring. L-6/BR-80 Grundrouting.</p>
        </div>
      </section>

      <!-- 04 GerÃ¤teÃ¼bersicht & Texture Lab -->
      <section id="ch04" class="card" data-cid="04">
        <div class="hd"><h2>GerÃ¤teÃ¼bersicht & Texture Lab</h2><span class="pill">Kapitel 04</span></div>
        <div class="bd">
          <!-- cid:04:audio:start -->
          <h3 id="dev-audio">{#audio}Audio</h3>
          <p class="muted">Mixer/Recorder, Ein-/AusgÃ¤nge, Pegel, FX-Sends.</p>
          <!-- cid:04:audio:end -->

          <!-- cid:04:midi:start -->
          <h3 id="dev-midi">{#midi}MIDI</h3>
          <p class="muted">KanÃ¤le, Program-Change, Clock-Verteilung, CC-Maps.</p>
          <!-- cid:04:midi:end -->
        </div>
      </section>

      <!-- 05 Workflows Audio â€“ Recording -->
      <section id="ch05" class="card" data-cid="05">
        <div class="hd"><h2>Workflows Audio â€“ Recording</h2><span class="pill">Kapitel 05</span></div>
        <div class="bd">
          <!-- cid:05:list -->
          <ul>
            <li>Workflow 1 â€“ Rear Line-In Summe â†’ Live Rec â†’ Import in MTR</li>
            <li>Workflow 1A â€“ Texture Lab Sampling/Extrasspur</li>
          </ul>
        </div>
      </section>

      <!-- 06 Workflows Audio â€“ Performance -->
      <section id="ch06" class="card" data-cid="06">
        <div class="hd"><h2>Workflows Audio â€“ Performance</h2><span class="pill">Kapitel 06</span></div>
        <div class="bd">
          <!-- cid:06:list -->
          <ul>
            <li>E-4 Mic-In Umschalten (DM-58 / T-8 / J-6 / Kombi)</li>
            <li>Live-FX & Resampling</li>
          </ul>
        </div>
      </section>

      <!-- 07 Workflows Audio â€“ Mixdown -->
      <section id="ch07" class="card" data-cid="07">
        <div class="hd"><h2>Workflows Audio â€“ Mixdown</h2><span class="pill">Kapitel 07</span></div>
        <div class="bd">
          <!-- cid:07:list -->
          <ul>
            <li>Spuren balancieren & Export</li>
            <li>Masterprozessoren & Pegelziele</li>
          </ul>
        </div>
      </section>

      <!-- 08 Zusammenfassung -->
      <section id="ch08" class="card" data-cid="08">
        <div class="hd"><h2>Zusammenfassung</h2><span class="pill">Kapitel 08</span></div>
        <div class="bd">
          <!-- cid:08:text -->
          <p class="muted">Kernregeln und Shortcuts (Audio & MIDI) auf einen Blick.</p>
        </div>
      </section>

      <section class="card">
        <div class="hd"><h2>Output</h2><span class="pill">Apply JSON2</span></div>
        <div class="bd" id="output"><div class="log">Bereit. WÃ¤hle Ziel-Dateien und lade dein JSON2, dann â€žAnwendenâ€œ.</div></div>
      </section>
    </main>
  </div>

  <!-- Upload-Dialog Engine (kein Drag&Drop) -->
  <script>
  const files = {}; let json2Obj = null;

  pickFilesBtn.onclick = () => filesInput.click();
  pickJson2Btn.onclick = () => json2Input.click();

  filesInput.onchange = async (e) => {
    for (const f of e.target.files) files[f.name] = await f.text();
    info(\`Geladen: \${Object.keys(files).join(', ') || 'â€”'}\`);
  };
  json2Input.onchange = async (e) => {
    const f = e.target.files[0]; if (!f) return;
    try { json2Obj = JSON.parse(await f.text()); info(\`JSON2 geladen: \${f.name}\`); }
    catch(err){ error('JSON2 ist ungÃ¼ltig: ' + err.message); }
  };

  applyBtn.onclick = async () => {
    if (!json2Obj) return error('Bitte zuerst JSON2 laden.');
    if (!Object.keys(files).length) return error('Bitte zuerst Ziel-Dateien wÃ¤hlen.');
    let configYAML = ''; try { const r = await fetch('apply-json.config.yml'); if (r.ok) configYAML = await r.text(); } catch(e){}
    const spec = toEngineSpec(json2Obj);
    const { files: updated, changelog } = ApplyJsonEngine.applyJson({ json2: spec, files: {...files}, configYAML });
    const out = [];
    for (const [name, text] of Object.entries(updated)) out.push(\`<h3>\${esc(name)}</h3><pre>\${esc(text)}</pre>\`);
    out.push(\`<h3>Changelog</h3><pre>\${esc(JSON.stringify(changelog, null, 2))}</pre>\`);
    output.innerHTML = out.join('\\n');
  };

  // --- Spezifikation laut Manifest v1.3 (CID-Nummerierung Ã¼bernommen) ---
  // Erwartet: { "file.md": { "actions":[ {type, cid|cid_start|cid_end|id, content_md|content} ] }, ... }
  function toEngineSpec(json2){
    const changes = [];
    for (const [file, block] of Object.entries(json2)) {
      (block.actions || []).forEach((a, i) => {
        const target = { file };
        if (a.cid) target.cid = a.cid;                 // z.B. "02:intro"
        if (a.cid_start) target.cid_start = a.cid_start; // z.B. "04:audio:start"
        if (a.cid_end) target.cid_end = a.cid_end;       // z.B. "04:audio:end"
        if (a.id)  target.id  = a.id;                  // z.B. "routing-performance"
        changes.push({ id: \`\${file}#\${i+1}\`, target, op: a.type, content: a.content_md || a.content || '' });
      });
    }
    return { changes };
  }

  function esc(s){return s.replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]));}
  function info(msg){ output.innerHTML = \`<div class="log">\${esc(msg)}</div>\`; }
  function error(msg){ output.innerHTML = \`<div class="log error">\${esc(msg)}</div>\`; }

  // --- ApplyJsonEngine: CID/ID-Operationen ---
  const ApplyJsonEngine = (function(){
    const CID_START = name => new RegExp(\`<!--\\\\s*cid:\${rx(name)}:start\\\\s*-->\`, 'i');
    const CID_END   = name => new RegExp(\`<!--\\\\s*cid:\${rx(name)}:end\\\\s*-->\`, 'i');
    const CID_ONE   = name => new RegExp(\`<!--\\\\s*cid:\${rx(name)}\\\\s*-->\`, 'i');
    const MD_ID     = id   => new RegExp(\`^.*\\\\{#\${rx(id)}\\\\}\\\\s*$\`, 'm');
    const HTML_ID   = id   => new RegExp(\`id=["']\${rx(id)}["']\`, 'i');
    function rx(s){ return s.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\\\$&'); }

    function insertAfterCid(t, name, content){
      const m = t.match(CID_ONE(name)); if(!m) return {t, ok:false, reason:\`CID \${name} nicht gefunden\`};
      const i = t.search(CID_ONE(name)); const end = i + m[0].length;
      return { t: t.slice(0,end) + "\\n" + content + "\\n" + t.slice(end), ok:true };
    }
    function replaceBetweenCids(t, startName, endName, content){
      const sRe = CID_START(startName), eRe = CID_END(endName);
      const s = t.search(sRe); if (s < 0) return {t, ok:false, reason:\`CID-Start \${startName} fehlt\`};
      const after = t.slice(s); const eMatch = after.match(eRe); if(!eMatch) return {t, ok:false, reason:\`CID-Ende \${endName} fehlt\`};
      const e = s + after.search(eRe) + eMatch[0].length;
      const startTag = after.match(sRe)[0], endTag = eMatch[0];
      return { t: t.slice(0, s) + startTag + "\\n" + content + "\\n" + endTag + t.slice(e), ok:true };
    }
    function insertAtId(t, id, content){
      const md = t.search(MD_ID(id));
      if (md >= 0){
        const lines = t.split(/\\r?\\n/); let acc=0;
        for (let i=0;i<lines.length;i++){ const prev=acc; acc += lines[i].length+1; if (prev<=md && md<acc){ lines.splice(i+1,0,content); return {t:lines.join("\\n"), ok:true}; } }
      }
      const hi = t.search(HTML_ID(id));
      if (hi >= 0){
        const lines = t.split(/\\r?\\n/); let cur=0;
        for (let i=0;i<lines.length;i++){ const L=lines[i]; if (cur<=hi && hi<cur+L.length+1){ lines.splice(i+1,0,content); return {t:lines.join("\\n"), ok:true}; } cur+=L.length+1; }
      }
      return { t, ok:false, reason:\`ID \${id} nicht gefunden\` };
    }
    function appendToFile(t, content){ return { t:(t.endsWith("\\n")?t:t+"\\n") + content + "\\n", ok:true }; }

    function applyJson({ json2, files }){
      const changes = (json2 && json2.changes) || []; const updated = {...files}; const log=[];
      for (const ch of changes){
        const { id, target={}, op, content='' } = ch; const name = target.file;
        if (!name || !(name in updated)){ log.push({id,file:name,ok:false,reason:'Datei nicht geladen'}); continue; }
        let t = updated[name], res=null;
        if (op==='insert_after_cid' && target.cid) res = insertAfterCid(t, target.cid, content);
        else if (op==='replace_between_cids' && target.cid_start && target.cid_end) res = replaceBetweenCids(t, target.cid_start, target.cid_end, content);
        else if (op==='insert_at_id' && target.id) res = insertAtId(t, target.id, content);
        else if (op==='append_to_file') res = appendToFile(t, content);
        else res = { t, ok:false, reason:\`Unbekannte/ungÃ¼ltige Operation: \${op}\` };
        if (res.ok){ updated[name]=res.t; log.push({id,file:name,ok:true,op}); }
        else { log.push({id,file:name,ok:false,op,reason:res.reason}); }
      }
      return { files: updated, changelog: log };
    }
    return { applyJson };
  })();
  </script>
</body>
</html>
