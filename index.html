index_html = """<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Musik Koffer – Workbench</title>
  <style>
    /* ===== Hard black/white + override any theme ===== */
    html, body { background:#fff !important; color:#000 !important; margin:0; padding:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    *, *::before, *::after { box-sizing:border-box; }
    :root { --pad:16px; --nav-w: clamp(220px, 22vw, 360px); }

    header, .wrap, main, aside, pre, #reviewPanel, #toc {
      background:#fff !important; color:#000 !important;
    }
    header { display:flex; gap:8px; align-items:center; padding:12px var(--pad);
      border-bottom:1px solid #000 !important; }
    header h1 { margin:0; font-size:1.35rem; flex:1 }
    #status { font-size:.9rem }
    .toolbar { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap }
    button { background:#fff; color:#000; border:1px solid #000; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed }
    .badge { display:none; margin-left:.4rem; padding:.1rem .4rem; background:#000; color:#fff; border:1px solid #000 }

    .wrap { display:grid; grid-template-columns:var(--nav-w) 1fr; min-height:calc(100vh - 64px) }
    aside { position:sticky; top:64px; height:calc(100vh - 64px); overflow:auto; padding:12px; border-right:1px solid #000 !important; }
    main { padding:clamp(12px,2vw,24px) }

    /* TOC links – pure black/white, no inversion */
    .toc a { display:block; padding:12px; text-decoration:none; color:#000;
      border-bottom:1px solid #000 }
    .toc a:hover { text-decoration:underline; background:#fff !important; color:#000 !important; }
    .toc a.active { background:#fff !important; color:#000 !important; font-weight:700;
      border-left:4px solid #000; padding-left:8px; }

    #chapterTitle { margin:.2rem 0 .6rem 0; font-size:1.3rem }
    pre { white-space:pre-wrap; word-wrap:break-word; padding:16px; line-height:1.45;
      border:1px solid #000 !important; }

    /* Floating Inhalts-Button – always visible */
    #navFab {
      position:fixed; right:16px; bottom:16px; z-index:2147483647;
      padding:.65rem 1rem; border:2px solid #000; background:#000; color:#fff; font-weight:700;
      border-radius:8px;
    }
    #navFab:focus { outline:2px solid #111; outline-offset:2px }

    /* Optional second toggle in header for desktop */
    #btnToggleNav { }

    /* Mobile drawer behaviour */
    @media (max-width: 900px){
      .wrap { grid-template-columns:1fr }
      aside {
        position:fixed; inset:auto 0 0 0; top:0; height:100vh; width:82vw; max-width:430px;
        transform:translateX(-100%); transition:transform .2s ease;
        box-shadow:0 0 0 9999px rgba(0,0,0,.25); z-index:1000;
      }
      body.nav-open aside { transform:none }
    }
  </style>
</head>
<body>
<header>
  <h1>Musik Koffer – Workbench</h1>
  <div id="status">Bereit. Kapitel wählen …</div>
  <button id="btnToggleNav" aria-expanded="false" aria-controls="nav">☰ Inhalt</button>
  <div class="toolbar">
    <button id="btnOpenReview">Kommentar-Review <span id="badgeComments" class="badge">0</span></button>
    <button id="btnExportJSON2" disabled>JSON 2 erzeugen</button>
  </div>
</header>

<!-- Floating global toggle -->
<button id="navFab" aria-expanded="false" aria-controls="nav" aria-label="Inhaltsverzeichnis öffnen oder schließen">☰ Inhalt</button>

<div class="wrap">
  <aside id="nav" aria-label="Inhaltsverzeichnis">
    <div id="toc" class="toc">Manifest wird geladen …</div>
  </aside>
  <main>
    <h2 id="chapterTitle">Kapitel</h2>
    <pre id="chapterContent">Bitte Kapitel im Inhaltsverzeichnis wählen…</pre>
    <div id="reviewPanel" style="display:none"></div>
  </main>
</div>

<script>
/* ===== Manifest + path handling =====
   Expect: chapter/manifest.json lives next to this index.html (./chapter/…)
*/
const MANIFEST_URL = new URL('./chapter/manifest.json', location.href).href;
const REPO_ROOT = new URL('./', location.href).href;

function resolveUrl(path){
  if(!path) return '';
  try { return new URL(path, REPO_ROOT).href; } catch { return path; }
}

function pagesToRaw(url){
  try{
    const u = new URL(url);
    // e.g. https://stickysmart.github.io/MusikKoffer/chapter/01_x.md
    const user = location.hostname.split('.')[0]; // stickysmart
    const parts = location.pathname.split('/').filter(Boolean);
    // [ 'MusikKoffer', 'index.html' ... ]
    const repo = parts[0] || 'MusikKoffer';
    const afterRepo = u.pathname.split('/').slice(2).join('/'); // skip /MusikKoffer/
    return `https://raw.githubusercontent.com/${user}/${repo}/main/${afterRepo}`;
  }catch(e){ return url; }
}

/* ===== Store & helpers ===== */
function ensureStore(){ window.DATA = window.DATA || {records:[],meta:{},comments:[]}; return window.DATA; }
function unresolvedCount(s){ return (s.comments||[]).filter(c=>c.status==='open').length; }
function canExportJSON2(s){ return unresolvedCount(s)===0; }
function setStatus(t){ const el=document.querySelector('#status'); if(el) el.textContent = t; }
function setErr(t){ /* kept minimal for BW mode */ console.warn(t); }
function enforceExportGuard(s){
  const btn=document.querySelector('#btnExportJSON2');
  const badge=document.querySelector('#badgeComments');
  const n=unresolvedCount(s);
  if(badge){ badge.textContent=n; badge.style.display = n? 'inline-block':'none'; }
  if(btn){ btn.disabled=!canExportJSON2(s); btn.title = btn.disabled ? 'Export gesperrt: erst Kommentare erledigen.' : 'Bereit für JSON 2.'; }
}

async function fetchText(url){
  const r = await fetch(url, {cache:'no-store'});
  if(!r.ok) throw new Error(url+' → '+r.status);
  return await r.text();
}
async function fetchJSON(url){
  const r = await fetch(url, {cache:'no-store'});
  if(!r.ok) throw new Error(url+' → '+r.status);
  return await r.json();
}

/* ===== MD data fences (optional) ===== */
function extractDataBlocks(md){
  const re=/```(json|yaml)\\s+data:(append|upsert|remove)(?:\\s+key=([A-Za-z0-9_-]+))?\\s*([\\s\\S]*?)```/g;
  const out=[]; let m; while((m=re.exec(md))!==null){ out.push({lang:m[1],op:m[2],key:m[3]||'id',body:m[4].trim()}); } return out;
}
function parseJSONRelaxed(txt){ return JSON.parse(txt.replace(/\\/\\/.*$/mg,'').replace(/\\/\\*[\\s\\S]*?\\*\\//g,'')); }
function indexBy(arr,key){ const m=new Map(); for(const o of arr) m.set(o[key],o); return m; }
function upsertMany(store,arr,key){ const m=indexBy(store.records,key); for(const o of arr){ const k=o[key]; if(m.has(k)){ Object.assign(m.get(k),o);} else { store.records.push(o); m.set(k,o);} } }
function removeMany(store,ids,key){ const set=new Set(ids); store.records=store.records.filter(o=>!set.has(o[key])); }
function addComment(store,{targetKey,text}){ const id='C'+Math.random().toString(36).slice(2,8); store.comments.push({id,targetKey,text,createdAt:new Date().toISOString(),status:'open'}); }

async function importFromMarkdown(mdUrl){
  const s=ensureStore();
  const before = new Map(s.records.map(r=>[r.id, JSON.stringify(r)]));
  let md;
  try {
    md = await fetchText(mdUrl);
  } catch (e) {
    const raw = pagesToRaw(mdUrl);
    md = await fetchText(raw); // throws if also fails
  }
  // optional data capture
  for(const b of extractDataBlocks(md)){
    const payload = parseJSONRelaxed(b.body);
    if(b.op==='append'){ const arr=Array.isArray(payload)?payload:[payload]; s.records.push(...arr); }
    if(b.op==='upsert'){ const arr=Array.isArray(payload)?payload:[payload]; upsertMany(s,arr,b.key); }
    if(b.op==='remove'){ const ids=Array.isArray(payload)?payload:[payload]; removeMany(s,ids,b.key); }
  }
  enforceExportGuard(s);
  return {md};
}

/* ===== Build TOC ===== */
function cleanFileLabel(filename){
  return filename.replace(/^[0-9]+[\\s_\\-–]*?/,'').replace(/\\.md$/i,'').replace(/_/g,' ');
}

async function buildTOC(){
  setStatus('Manifest laden …');
  const mf = await fetchJSON(MANIFEST_URL);
  const raw = (mf.chapters||[]).filter(Boolean);
  const toc = document.querySelector('#toc');

  const items = raw.map((entry, idx)=>{
    if (typeof entry === 'string') {
      const file = entry.split('/').pop();
      const label = `${String(idx+1).padStart(2,'0')} – ${cleanFileLabel(file)}`;
      const url = resolveUrl(entry);
      return {label, url};
    } else {
      const path = entry.path || '';
      const url = resolveUrl(path);
      const id  = (entry.id != null) ? String(entry.id).padStart(2,'0')+' – ' : '';
      const label = id + (entry.title || cleanFileLabel(path.split('/').pop()));
      return {label, url};
    }
  });

  toc.innerHTML = items.map(it=>`<a href="#" data-url="${it.url}">${it.label}</a>`).join('');

  toc.addEventListener('click', async (e)=>{
    const a = e.target.closest('a'); if(!a) return;
    e.preventDefault();
    document.querySelectorAll('.toc a').forEach(el=>el.classList.remove('active'));
    a.classList.add('active');
    const url = a.getAttribute('data-url');
    setStatus('Kapitel laden …');
    try{
      const {md} = await importFromMarkdown(url);
      document.querySelector('#chapterTitle').textContent = a.textContent;
      document.querySelector('#chapterContent').textContent = md;
      setStatus('Fertig.');
    }catch(err){
      setStatus('Fehler beim Laden.');
      console.warn(err);
    }
    if (window.matchMedia('(max-width: 900px)').matches) toggleNav(false);
    document.querySelector('#chapterTitle').scrollIntoView({behavior:'smooth',block:'start'});
  });

  setStatus('Bereit. Kapitel wählen …');
}

/* ===== Review & Export ===== */
document.querySelector('#btnOpenReview').addEventListener('click', ()=>{
  const p=document.querySelector('#reviewPanel');
  p.style.display = p.style.display==='block' ? 'none':'block';
});
document.querySelector('#btnExportJSON2').addEventListener('click', ()=>{
  const s=ensureStore(); if(!canExportJSON2(s)){ alert('Export gesperrt: offene Kommentare.'); return; }
  const blob=new Blob([JSON.stringify({version:s.meta?.version||'dev',updated:new Date().toISOString(),items:s.records},null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=Object.assign(document.createElement('a'),{href:url,download:'export_JSON2.json'}); a.click(); setTimeout(()=>URL.revokeObjectURL(url),1500);
});

/* ===== Drawer toggles (header + floating) ===== */
const fab = document.getElementById('navFab');
const btn = document.getElementById('btnToggleNav');
function toggleNav(force){
  const open = (typeof force==='boolean') ? force : !document.body.classList.contains('nav-open');
  document.body.classList.toggle('nav-open', open);
  fab?.setAttribute('aria-expanded', String(open));
  btn?.setAttribute('aria-expanded', String(open));
}
fab.addEventListener('click', (e)=>{ e.stopPropagation(); toggleNav(); });
btn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleNav(); });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') toggleNav(false); });
document.addEventListener('click', (e)=>{
  if(document.body.classList.contains('nav-open')){
    const a = document.getElementById('nav');
    if(a && !a.contains(e.target) && e.target!==fab && e.target!==btn){ toggleNav(false); }
  }
});

/* ===== Boot ===== */
window.addEventListener('DOMContentLoaded', buildTOC);
</script>
</body>
</html>
"""
Path("/mnt/data/index.html").write_text(index_html, encoding="utf-8")
print("Wrote /mnt/data/index.html")
