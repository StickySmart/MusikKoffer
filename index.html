<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Tiage Music Masterplan 25</title>
  <style>
    body { font-family: monospace; margin: 0; padding: 0; }
    header { background: #111; color: #fff; padding: 15px; }
    header h1 { margin: 0; font-size: 24px; }
    #buttons { margin-top: 10px; }
    #buttons button {
      margin-right: 10px;
      background: #333;
      color: #fff;
      border: none;
      padding: 6px 12px;
      cursor: pointer;
    }
    #buttons button:hover { background: #555; }
    #toc { padding: 15px; background: #f4f4f4; }
    #content { padding: 15px; }
  </style>
</head>
<body>
  <header>
    <h1>Tiage Music Masterplan 25</h1>
    <div id="buttons">
      <button onclick="exportJson1()">ExpJ1</button>
      <button onclick="exportJson2()">ExpJ2</button>
      <button onclick="importJson2()">ImpJ2</button>
    </div>
  </header>

  <!-- Inhaltsverzeichnis -->
  <div id="toc"></div>

  <!-- Kapitel- oder Modul-Inhalt -->
  <div id="content">Bitte Kapitel oder Modul wählen…</div>

  <script>
    let currentChapter = null;
    let currentText = "";

    async function loadManifest() {
      try {
        const response = await fetch("manifest.json");
        if (!response.ok) throw new Error("Manifest nicht gefunden");
        const manifest = await response.json();
        renderToc(manifest);
      } catch (err) {
        document.getElementById("toc").innerHTML =
          `<p style="color:red;">Fehler beim Laden des Manifests: ${err.message}</p>`;
      }
    }

    function renderToc(manifest) {
      const tocDiv = document.getElementById("toc");
      let html = "<h2>Kapitel</h2><ul>";

      manifest.chapters.forEach(ch => {
        html += `<li><a href="#" onclick="loadChapter('${ch.path}')">${ch.id} – ${ch.title}</a></li>`;
      });

      html += "</ul><h2>Module</h2><ul>";

      manifest.files && Object.keys(manifest.files).forEach(key => {
        const file = manifest.files[key];
        html += `<li><a href="#" onclick="loadModule('${file}')">${key} – ${file}</a></li>`;
      });

      html += "</ul>";
      tocDiv.innerHTML = html;
    }

    async function loadChapter(path) {
      try {
        const response = await fetch(path);
        if (!response.ok) throw new Error("Kapitel nicht gefunden");
        const text = await response.text();
        currentChapter = path;
        currentText = text;
        document.getElementById("content").innerHTML =
          `<pre>${text}</pre>`;
      } catch (err) {
        document.getElementById("content").innerHTML =
          `<p style="color:red;">Fehler beim Laden des Kapitels: ${err.message}</p>`;
      }
    }

    async function loadModule(path) {
      try {
        const response = await fetch(path);
        if (!response.ok) throw new Error("Modul nicht gefunden");
        const text = await response.text();
        document.getElementById("content").innerHTML =
          `<h3>XML Modul: ${path}</h3><pre>${text}</pre>`;
      } catch (err) {
        document.getElementById("content").innerHTML =
          `<p style="color:red;">Fehler beim Laden des Moduls: ${err.message}</p>`;
      }
    }

    // --- JSON Export/Import ---
    function exportJson1() {
      const data = { chapter: currentChapter, text: currentText };
      downloadFile("json1-export.json", JSON.stringify(data, null, 2));
    }

    function exportJson2() {
      const data = { changes: [], timestamp: Date.now() };
      downloadFile("json2-export.json", JSON.stringify(data, null, 2));
    }

    async function importJson2() {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "application/json";
      input.onchange = async (e) => {
        const file = e.target.files[0];
        const text = await file.text();
        try {
          const json2 = JSON.parse(text);
          applyJson2(json2);
        } catch (err) {
          alert("Ungültiges JSON2-Format: " + err.message);
        }
      };
      input.click();
    }

    function applyJson2(json2) {
      if (!json2.changes || json2.changes.length === 0) {
        document.getElementById("content").innerHTML =
          "<p>Keine Änderungen aus JSON2 angewendet.</p>";
        return;
      }
      let result = currentText;
      json2.changes.forEach(change => {
        if (change.type === "replace") {
          result = result.replace(change.target, change.newText);
        } else if (change.type === "append") {
          result += "\n" + change.newText;
        }
      });
      document.getElementById("content").innerHTML = `<pre>${result}</pre>`;
    }

    function downloadFile(filename, content) {
      const blob = new Blob([content], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Initial
    loadManifest();
  </script>
</body>
</html>