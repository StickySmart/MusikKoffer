<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Musik Koffer â€“ Workbench</title>
  <style>
    :root{--pad:16px}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0}
    header{padding:12px var(--pad);border-bottom:1px solid #eee}
    .wrap{display:grid;grid-template-columns:300px 1fr;min-height:calc(100vh - 60px)}
    aside{border-right:1px solid #eee;padding:12px}
    main{padding:var(--pad)}
    .toc a{display:block;padding:8px 10px;border-radius:8px;text-decoration:none;color:inherit}
    .toc a:hover{background:#f5f5f5}
    .toc a.active{background:#eef5ff}
    .toolbar{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;margin-top:.35rem}
    .badge{display:none;margin-left:.4rem;padding:.1rem .4rem;border-radius:999px;background:#d33;color:#fff;font-size:.8rem;min-width:1.2rem;text-align:center}
    pre{white-space:pre-wrap;word-wrap:break-word;background:#fafafa;border:1px solid #eee;border-radius:8px;padding:12px}
    #reviewPanel{display:none;margin-top:12px;padding:.75rem;border:1px solid #ddd;border-radius:8px}
    #status{font-size:.9rem;opacity:.8}
  </style>
</head>
<body>
<header>
  <h1 style="margin:0">Musik Koffer â€“ Workbench</h1>
  <div id="status">Bereit.</div>
  <div class="toolbar">
    <button id="btnOpenReview">Kommentar-Review <span id="badgeComments" class="badge">0</span></button>
    <button id="btnExportJSON2" disabled>JSON 2 erzeugen</button>
  </div>
</header>

<div class="wrap">
  <aside>
    <div id="toc" class="toc">Manifest wird geladen â€¦</div>
  </aside>
  <main>
    <h2 id="chapterTitle">Kapitel</h2>
    <pre id="chapterContent">Bitte Kapitel im Inhaltsverzeichnis wÃ¤hlenâ€¦</pre>
    <div id="reviewPanel"></div>
  </main>
</div>

<script>
// ===== Helpers & Store =====
function ensureStore(){ window.DATA = window.DATA || {records:[],meta:{},comments:[]}; return window.DATA; }
function unresolvedCount(s){ return (s.comments||[]).filter(c=>c.status==='open').length; }
function canExportJSON2(s){ return unresolvedCount(s)===0; }
function setStatus(t){ const el=document.querySelector('#status'); if(el) el.textContent = t; }
function enforceExportGuard(s){
  const btn=document.querySelector('#btnExportJSON2');
  const badge=document.querySelector('#badgeComments');
  const n=unresolvedCount(s);
  if(badge){ badge.textContent=n; badge.style.display = n? 'inline-block':'none'; }
  if(btn){ btn.disabled=!canExportJSON2(s); btn.title = btn.disabled ? 'Export gesperrt: erst Kommentare erledigen.' : 'Bereit fÃ¼r JSON 2.'; }
}
async function fetchText(url){ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error(url+' â†’ '+r.status); return await r.text(); }
async function fetchJSON(url){ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error(url+' â†’ '+r.status); return await r.json(); }

// ===== MD parsing minimal (data:* fences) =====
function extractDataBlocks(md){
  const re=/```(json|yaml)\s+data:(append|upsert|remove)(?:\s+key=([A-Za-z0-9_-]+))?\s*([\s\S]*?)```/g;
  const out=[]; let m; while((m=re.exec(md))!==null){ out.push({lang:m[1],op:m[2],key:m[3]||'id',body:m[4].trim()}); } return out;
}
function parseJSONRelaxed(txt){ return JSON.parse(txt.replace(/\/\/.*$/mg,'').replace(/\/\*[\s\S]*?\*\//g,'')); }
function indexBy(arr,key){ const m=new Map(); for(const o of arr) m.set(o[key],o); return m; }
function upsertMany(store,arr,key){ const m=indexBy(store.records,key); for(const o of arr){ const k=o[key]; if(m.has(k)){ Object.assign(m.get(k),o);} else { store.records.push(o); m.set(k,o);} } }
function removeMany(store,ids,key){ const set=new Set(ids); store.records=store.records.filter(o=>!set.has(o[key])); }
function addComment(store,{targetKey,text}){ const id='C'+Math.random().toString(36).slice(2,8); store.comments.push({id,targetKey,text,createdAt:new Date().toISOString(),status:'open'}); }

async function importFromMarkdown(mdUrl){
  const s=ensureStore();
  const before = new Map(s.records.map(r=>[r.id, JSON.stringify(r)]));
  const md = await fetchText(mdUrl);

  // Frontmatter optional
  const fm = md.match(/^---\n([\s\S]*?)\n---/);
  if(fm){ s.meta = s.meta || {}; s.meta.frontmatter = fm[1]; }

  // Fenced data-blocks
  for(const b of extractDataBlocks(md)){
    const payload = parseJSONRelaxed(b.body);
    if(b.op==='append'){ const arr=Array.isArray(payload)?payload:[payload]; s.records.push(...arr); }
    if(b.op==='upsert'){ const arr=Array.isArray(payload)?payload:[payload]; upsertMany(s,arr,b.key); }
    if(b.op==='remove'){ const ids=Array.isArray(payload)?payload:[payload]; removeMany(s,ids,b.key); }
  }

  // Auto-Review fÃ¼r Neu/Ã„nderung/Remove
  const seen = new Set();
  for(const rec of s.records){
    seen.add(rec.id);
    const prev = before.get(rec.id);
    const now = JSON.stringify(rec);
    if(prev===undefined) addComment(s,{targetKey:rec.id,text:`Neuer Datensatz: ${rec.title??rec.id} prÃ¼fen.`});
    else if(prev!==now) addComment(s,{targetKey:rec.id,text:`Ã„nderungen an ${rec.title??rec.id} sichten.`});
  }
  for(const [id] of before){ if(!seen.has(id)) addComment(s,{targetKey:id,text:`Datensatz entfernt: ${id}. Korrekt?`}); }

  enforceExportGuard(s);
  return {md};
}

// ===== Review & Export =====
function openReview(){
  const s=ensureStore(); const p=document.querySelector('#reviewPanel');
  const items=(s.comments||[]).sort((a,b)=>a.status.localeCompare(b.status));
  p.innerHTML=items.map(c=>`
    <div class="card">
      <div style="font-weight:700">#${c.id} â€“ ${c.status==='open'?'ðŸŸ¥ Offen':'ðŸŸ© Erledigt'}</div>
      <div style="opacity:.8">Ziel: <code>${c.targetKey??'-'}</code></div>
      <p style="margin:.35rem 0 .5rem">${c.text}</p>
      ${c.status==='open'
        ? \`<textarea id="note-\${c.id}" placeholder="Anmerkung (optional)" style="width:100%;min-height:3rem"></textarea>
           <div style="display:flex;gap:.5rem;margin-top:.5rem">
             <button onclick="resolveComment('\${c.id}')">Als erledigt markieren</button>
           </div>\`
        : \`<em>Erledigt am: \${c.resolvedAt??'-'}</em>\`
      }
    </div>`).join('');
  p.style.display='block';
}
function resolveComment(id){
  const s=ensureStore(); const c=s.comments.find(x=>x.id===id); if(!c) return;
  const note=document.querySelector('#note-'+id); c.status='resolved'; c.resolverNote=note?.value||''; c.resolvedAt=new Date().toISOString();
  enforceExportGuard(s); openReview();
}
function buildJSON2(s){ return {version:s.meta?.version||'dev',updated:new Date().toISOString(),items:s.records}; }
function exportJSON2(){
  const s=ensureStore(); if(!canExportJSON2(s)){ alert('Export gesperrt: Es sind noch offene Kommentare vorhanden.'); return; }
  const blob=new Blob([JSON.stringify(buildJSON2(s),null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=Object.assign(document.createElement('a'),{href:url,download:'export_JSON2.json'}); a.click(); setTimeout(()=>URL.revokeObjectURL(url),1500);
}

// ===== Build TOC & interactions =====
async function buildTOC(){
  try{
    const mf = await fetchJSON('./chapter/manifest.json');
    const base = mf.base || './';
    const list = (mf.chapters||[]).map(p => typeof p==='string' ? p : p.path).filter(Boolean);
    const toc = document.querySelector('#toc');
    toc.innerHTML = list.map((rel,idx)=>{
      const label = rel.split('/').pop();
      const url = rel.startsWith('http') ? rel : (base + rel);
      return `<a href="#" data-url="${url}">${(idx+1).toString().padStart(2,'0')} â€“ ${label}</a>`;
    }).join('');

    toc.addEventListener('click', async (e)=>{
      const a = e.target.closest('a'); if(!a) return;
      e.preventDefault();
      document.querySelectorAll('.toc a').forEach(el=>el.classList.remove('active'));
      a.classList.add('active');
      const url = a.getAttribute('data-url');
      setStatus('Kapitel laden â€¦');
      const {md} = await importFromMarkdown(url);
      document.querySelector('#chapterTitle').textContent = a.textContent;
      document.querySelector('#chapterContent').textContent = md;
      setStatus('Fertig. '+unresolvedCount(ensureStore())+' offene Kommentare.');
    });

    setStatus('Bereit. Kapitel wÃ¤hlen â€¦');
  }catch(e){
    setStatus('Fehler beim Laden des Manifest: '+(e?.message||e));
    document.querySelector('#toc').textContent = 'Manifest konnte nicht geladen werden.';
  }
}

document.querySelector('#btnOpenReview').addEventListener('click', openReview);
document.querySelector('#btnExportJSON2').addEventListener('click', exportJSON2);
window.addEventListener('DOMContentLoaded', buildTOC);
</script>
</body>
</html>
