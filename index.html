<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Tiage Music Masterplan 25</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
    header { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 1rem; background: #111; color: #fff; }
    #sidebar { width: 260px; background: #f5f5f5; border-right: 1px solid #ddd; overflow-y: auto; transition: transform 0.3s ease; }
    #sidebar.hidden { transform: translateX(-100%); }
    #content { flex: 1; padding: 1rem; overflow-y: auto; }
    main { display: flex; flex: 1; height: calc(100vh - 60px); }
    pre { background: #eee; padding: 0.5rem; overflow-x: auto; }
    table { border-collapse: collapse; margin-top: 1rem; }
    table, th, td { border: 1px solid #aaa; padding: 4px 8px; }
    #comments { margin-top: 2rem; padding: 1rem; border-top: 2px solid #ccc; }
    #comments textarea { width: 100%; height: 80px; }
    #comments button { margin-top: 0.5rem; padding: 0.3rem 0.6rem; }
    #topButtons button { background: #444; color: #fff; border: none; padding: 0.3rem 0.6rem; margin-left: 5px; cursor: pointer; }
    #menuBtn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
  </style>
</head>
<body>
  <header>
    <h1>Tiage Music Masterplan 25</h1>
    <div id="topButtons">
      <button id="exportJ1">ExpJ1</button>
      <button id="importJ2">ImpJ2</button>
      <button id="menuBtn">☰</button>
    </div>
  </header>

  <main>
    <nav id="sidebar">Lade Manifest …</nav>
    <section id="content">
      <h2>Willkommen</h2>
      <p>Bitte Kapitel oder Modul wählen…</p>
    </section>
  </main>

  <script>
    const sidebar = document.getElementById("sidebar");
    const menuBtn = document.getElementById("menuBtn");
    const content = document.getElementById("content");

    menuBtn.addEventListener("click", () => {
      sidebar.classList.toggle("hidden");
    });

    async function loadManifest() {
      try {
        const res = await fetch("manifest.json?v=" + Date.now());
        const manifest = await res.json();

        let html = "<h3>Kapitel</h3>";
        if (manifest.chapters) {
          html += manifest.chapters.map(ch =>
            `<p><a href="#" data-type="chapter" data-path="${ch.path}">${ch.id} – ${ch.title}</a></p>`
          ).join("");
        }

        html += "<h3>Module</h3>";
        if (manifest.modules) {
          html += manifest.modules.map(mod =>
            `<p><a href="#" data-type="module" data-path="${mod.source}">${mod.id} – ${mod.purpose}</a></p>`
          ).join("");
        }

        sidebar.innerHTML = html;

        sidebar.querySelectorAll("a").forEach(link => {
          link.addEventListener("click", async e => {
            e.preventDefault();
            const type = e.target.dataset.type;
            const path = e.target.dataset.path;
            if (type === "chapter") {
              await loadChapter(path);
            } else if (type === "module") {
              await loadModule(path);
            }
            sidebar.classList.add("hidden");
          });
        });
      } catch (err) {
        content.innerHTML = `<p style="color:red">Fehler beim Laden des Manifests: ${err}</p>`;
      }
    }

    async function loadChapter(path) {
      try {
        const res = await fetch(path);
        if (!res.ok) throw new Error(`${path} → ${res.status}`);
        const text = await res.text();
        content.innerHTML = `<article>${parseMarkdown(text)}</article>` + commentBox(path);
      } catch (err) {
        content.innerHTML = `<p style="color:red">Fehler beim Laden des Kapitels: ${err}</p>`;
      }
    }

    async function loadModule(path) {
      try {
        const res = await fetch(path);
        if (!res.ok) throw new Error(`${path} → ${res.status}`);
        const text = await res.text();
        const parser = new DOMParser();
        const xml = parser.parseFromString(text, "application/xml");

        let html = `<h2>XML Modul: ${path}</h2>`;
        html += renderXML(xml.documentElement);
        content.innerHTML = html + commentBox(path);
      } catch (err) {
        content.innerHTML = `<p style="color:red">Fehler beim Laden des Moduls: ${err}</p>`;
      }
    }

    function renderXML(node) {
      if (!node.children || node.children.length === 0) {
        return `<p>${node.tagName}: ${node.textContent}</p>`;
      }
      let html = `<h3>${node.tagName}</h3><ul>`;
      for (let child of node.children) {
        html += `<li><strong>${child.tagName}:</strong> ${child.textContent} ${renderXML(child)}</li>`;
      }
      html += "</ul>";
      return html;
    }

    function parseMarkdown(md) {
      return md
        .replace(/^### (.*$)/gim, "<h3>$1</h3>")
        .replace(/^## (.*$)/gim, "<h2>$1</h2>")
        .replace(/^# (.*$)/gim, "<h1>$1</h1>")
        .replace(/\*\*(.*)\*\*/gim, "<b>$1</b>")
        .replace(/\*(.*)\*/gim, "<i>$1</i>")
        .replace(/\n$/gim, "<br/>");
    }

    function commentBox(id) {
      return `
        <div id="comments">
          <h3>Kommentare zu: ${id}</h3>
          <textarea id="commentInput_${id}"></textarea><br>
          <button onclick="saveComment('${id}')">Kommentar speichern</button>
          <div id="commentList_${id}"></div>
        </div>
      `;
    }

    function saveComment(id) {
      const input = document.getElementById("commentInput_" + id);
      const list = document.getElementById("commentList_" + id);
      if (input.value.trim()) {
        const p = document.createElement("p");
        p.textContent = input.value;
        list.appendChild(p);
        input.value = "";
      }
    }

    loadManifest();
  </script>
</body>
</html>