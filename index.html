<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Tiage Music Masterplan 25</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #fff;
      color: #000;
    }
    header {
      background: #111;
      color: #fff;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.5em;
    }
    #menu {
      display: none;
      position: absolute;
      top: 60px;
      left: 0;
      background: #eee;
      padding: 15px;
      width: 80%;
      max-width: 320px;
      height: 100%;
      overflow-y: auto;
    }
    #menu a {
      display: block;
      margin: 8px 0;
      color: #000;
      text-decoration: none;
    }
    #menu a:hover {
      text-decoration: underline;
    }
    #content {
      padding: 20px;
    }
    pre {
      background: #f9f9f9;
      border: 1px solid #ccc;
      padding: 10px;
      overflow-x: auto;
      white-space: pre-wrap;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }
    th, td {
      border: 1px solid #333;
      padding: 6px;
      font-size: 14px;
    }
    #commentSection {
      margin-top: 20px;
      padding: 15px;
      background: #f9f9f9;
      border: 1px solid #ddd;
    }
    #commentSection textarea {
      width: 100%;
      height: 100px;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ddd;
      margin-bottom: 10px;
    }
    #commentSection button {
      padding: 8px 12px;
      margin-right: 10px;
      background: #333;
      color: white;
      border: none;
      cursor: pointer;
    }
    #commentSection button:hover {
      background: #555;
    }
  </style>
</head>
<body>
  <header>
    <h1>Tiage Music Masterplan 25</h1>
    <div>
      <button onclick="exportJson1()">ExpJ1</button>
      <button onclick="importJson2()">ImpJ2</button>
      <button onclick="toggleMenu()">☰</button>
    </div>
  </header>

  <div id="menu"></div>
  <div id="content">Bitte Kapitel oder Modul wählen…</div>

  <script>
    let manifest = null;

    // Menü laden
    async function loadManifest() {
      try {
        const response = await fetch("manifest.json");
        manifest = await response.json();
        renderMenu();
      } catch (e) {
        document.getElementById("content").innerHTML = "<p style='color:red'>Fehler beim Laden des Manifests: " + e + "</p>";
      }
    }

    function renderMenu() {
      let menu = document.getElementById("menu");
      let html = "<h3>Kapitel</h3>";
      manifest.chapters.forEach(ch => {
        html += `<a href="#" onclick="loadChapter('${ch.path}')" data-chapter="${ch.path}">${ch.id} – ${ch.title}</a>`;
      });
      html += "<h3>Module</h3>";
      manifest.modules.forEach(m => {
        html += `<a href="#" onclick="loadModule('${m.source}', '${m.purpose}')">${m.id} – ${m.purpose}</a>`;
      });
      menu.innerHTML = html;
    }

    function toggleMenu() {
      let menu = document.getElementById("menu");
      menu.style.display = (menu.style.display === "block") ? "none" : "block";
    }

    // Kapitel laden
    async function loadChapter(path) {
      try {
        const resp = await fetch(path);
        const text = await resp.text();
        document.getElementById("content").innerHTML =
          `<div data-chapter="${path}"><pre>${text}</pre></div>` +
          `<div id="commentSection" data-cid="${path}">
             <h3>Kommentare zu: ${path}</h3>
             <textarea id="commentInput" placeholder="Kommentar eingeben..."></textarea>
             <button onclick="saveComment('${path}')">Speichern</button>
           </div>`;
      } catch (e) {
        document.getElementById("content").innerHTML =
          `<p style="color:red">Fehler beim Laden des Kapitels: ${e}</p>`;
      }
    }

    // Module laden
    async function loadModule(source, purpose) {
      try {
        const resp = await fetch(source);
        const text = await resp.text();
        let parsed = parseXmlToTable(text);
        document.getElementById("content").innerHTML =
          `<h3>XML Modul: ${source}</h3>${parsed}`;
      } catch (e) {
        document.getElementById("content").innerHTML =
          `<p style="color:red">Fehler beim Laden des Moduls: ${e}</p>`;
      }
    }

    // Einfacher XML → Tabelle Parser
    function parseXmlToTable(xmlText) {
      let parser = new DOMParser();
      let xmlDoc = parser.parseFromString(xmlText, "text/xml");
      let rows = [];
      xmlDoc.querySelectorAll("*").forEach(node => {
        if (node.children.length === 0 && node.textContent.trim() !== "") {
          rows.push(`<tr><td>${node.nodeName}</td><td>${node.textContent}</td></tr>`);
        }
      });
      return `<table><tr><th>Tag</th><th>Wert</th></tr>${rows.join("")}</table>`;
    }

    // Dummy für Kommentar-Speichern
    function saveComment(path) {
      let input = document.getElementById("commentInput").value;
      alert("Kommentar gespeichert für " + path + ": " + input);
    }

    // Export JSON1
    function exportJson1() {
      let data = { timestamp: new Date().toISOString(), comments: [] };
      document.querySelectorAll("#commentSection").forEach(sec => {
        let cid = sec.getAttribute("data-cid");
        let val = sec.querySelector("textarea").value;
        if (val) data.comments.push({ chapter: cid, text: val });
      });
      let blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      let url = URL.createObjectURL(blob);
      let a = document.createElement("a");
      a.href = url;
      a.download = "json1-export.json";
      a.click();
    }

    // Import JSON2 (global anwenden)
    function importJson2() {
      let input = document.createElement("input");
      input.type = "file";
      input.accept = "application/json";
      input.onchange = e => {
        let file = e.target.files[0];
        let reader = new FileReader();
        reader.onload = evt => {
          let json2 = JSON.parse(evt.target.result);
          applyJson2(json2);
        };
        reader.readAsText(file);
      };
      input.click();
    }

    // applyJson2: global auf alle Kapitel anwenden
    function applyJson2(json2) {
      if (!json2) {
        alert("Keine JSON2-Daten geladen.");
        return;
      }

      let applied = 0;

      Object.keys(json2).forEach(chapterKey => {
        const entry = json2[chapterKey];
        if (!entry.actions) return;

        // Kapitelcontainer suchen
        const container = document.querySelector(`[data-chapter="${chapterKey}"]`);
        if (!container) return;

        entry.actions.forEach(action => {
          if (action.type === "insert_after") {
            container.insertAdjacentHTML("beforeend", action.content_md);
            applied++;
          }
          if (action.type === "append") {
            container.insertAdjacentHTML("beforeend", action.content_md);
            applied++;
          }
          if (action.type === "remove_section") {
            let targets = container.querySelectorAll(action.selector);
            targets.forEach(t => t.remove());
            applied++;
          }
        });
      });

      document.getElementById("content").insertAdjacentHTML("beforeend",
        `<p>${applied > 0 ? applied + " Änderungen aus JSON2 angewendet." : "Keine Änderungen aus JSON2 angewendet."}</p>`);
    }

    loadManifest();
  </script>
</body>
</html>